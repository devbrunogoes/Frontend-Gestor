import{r,c as L,o as N,a as d,b as o,f as a,z as S,e as T,j as w,A as V,F as E,g as I,v as B,D as k,t as s}from"./index-CXM7zIvA.js";import{l as M}from"./routes-D93I97QE.js";import{l as _}from"./routeExecutions-C1KIqcHM.js";import{B as z,a as O}from"./BaseError-DaDu2INT.js";/* empty css                                                                  */const Y={class:"content-area"},P={class:"page-header",style:{display:"flex","align-items":"center","justify-content":"space-between",gap:"1rem"}},q={class:"page-actions",style:{display:"flex",gap:".5rem","flex-wrap":"wrap","align-items":"center"}},G=["value"],H=["disabled"],J=["disabled"],K={key:2,class:"card",style:{"margin-bottom":"1rem",display:"flex",gap:"1rem","flex-wrap":"wrap"}},Q={key:3,class:"table-wrap"},W={class:"data-table"},lt={__name:"RelatorioRotasView",setup(X){const x=r([]),R=r([]),c=r(!1),v=r(""),m=r(""),f=r(""),g=r(""),p=r("");function y(l){try{return l?new Date(l).toLocaleString():"-"}catch{return"-"}}function A(l){try{const t=new Date(l);return isNaN(t)?null:t}catch{return null}}function C(l){const t=A(l);if(!t)return!0;if(f.value){const e=A(f.value);if(e&&t<new Date(e.getFullYear(),e.getMonth(),e.getDate()))return!1}if(g.value){const e=A(g.value);if(e&&t>new Date(e.getFullYear(),e.getMonth(),e.getDate(),23,59,59,999))return!1}return!0}const U=l=>{const t=x.value.find(e=>String(e.id)===String(l));return t?t.nome||t.name:"-"},u=L(()=>{let l=(R.value||[]).map(t=>{const e=Array.isArray(t.points)?t.points.filter(b=>b.status==="visited").length:0,i=Array.isArray(t.points)?t.points.length:0;return{id:t.id,rotaId:t.routeId,rota:U(t.routeId),startedAt:t.startedAt,finishedAt:t.finishedAt,status:t.status,visited:e,total:i}});return m.value&&(l=l.filter(t=>String(t.rotaId)===String(m.value))),p.value&&(l=l.filter(t=>t.status===p.value)),l=l.filter(t=>C(t.startedAt)),l.sort((t,e)=>new Date(e.startedAt||0)-new Date(t.startedAt||0)),l});async function h(){c.value=!0,v.value="";try{x.value=await M(),R.value=await _(m.value||null,p.value||null)}catch(l){v.value=(l==null?void 0:l.message)||"Erro ao carregar relatório de rotas"}finally{c.value=!1}}function j(){const l=["ID","Rota","Inicio","Fim","Status","Visitados","Total"],t=u.value.map(n=>[n.id,n.rota,y(n.startedAt),y(n.finishedAt),n.status,n.visited,n.total]),e=[l.join(","),...t.map(n=>n.map(F=>'"'+String(F).replace(/"/g,'""')+'"').join(","))].join(`
`),i=new Blob([e],{type:"text/csv;charset=utf-8;"}),b=URL.createObjectURL(i),D=document.createElement("a");D.href=b,D.download="relatorio-rotas.csv",D.click(),URL.revokeObjectURL(b)}return N(h),(l,t)=>(o(),d("section",Y,[a("div",P,[t[6]||(t[6]=a("h2",{style:{margin:"0"}},"Relatório de Rotas",-1)),a("div",q,[w(a("select",{class:"form-control","onUpdate:modelValue":t[0]||(t[0]=e=>m.value=e),style:{"min-width":"200px"}},[t[4]||(t[4]=a("option",{value:""},"Todas as Rotas",-1)),(o(!0),d(E,null,I(x.value,e=>(o(),d("option",{key:e.id,value:String(e.id)},s(e.nome||e.name),9,G))),128))],512),[[V,m.value]]),w(a("input",{class:"form-control",type:"date","onUpdate:modelValue":t[1]||(t[1]=e=>f.value=e)},null,512),[[B,f.value]]),w(a("input",{class:"form-control",type:"date","onUpdate:modelValue":t[2]||(t[2]=e=>g.value=e)},null,512),[[B,g.value]]),w(a("select",{class:"form-control","onUpdate:modelValue":t[3]||(t[3]=e=>p.value=e)},[...t[5]||(t[5]=[a("option",{value:""},"Todos status",-1),a("option",{value:"in_progress"},"Em Andamento",-1),a("option",{value:"completed"},"Concluída",-1)])],512),[[V,p.value]]),a("button",{class:"btn btn-secondary",onClick:h,disabled:c.value},"Atualizar",8,H),a("button",{class:"btn btn-outline",onClick:j,disabled:!u.value.length},"Exportar CSV",8,J)])]),v.value?(o(),S(z,{key:0,message:v.value,retry:h},null,8,["message"])):c.value?(o(),S(O,{key:1,message:"Carregando execuções de rota…"})):(o(),d("div",K,[a("div",null,[t[7]||(t[7]=a("strong",null,"Execuções:",-1)),k(" "+s(u.value.length),1)]),a("div",null,[t[8]||(t[8]=a("strong",null,"Concluídas:",-1)),k(" "+s(u.value.filter(e=>e.status==="completed").length),1)]),a("div",null,[t[9]||(t[9]=a("strong",null,"Visitas:",-1)),k(" "+s(u.value.reduce((e,i)=>e+i.visited,0))+" / "+s(u.value.reduce((e,i)=>e+i.total,0)),1)])])),!c.value&&!v.value?(o(),d("div",Q,[a("table",W,[t[10]||(t[10]=a("thead",null,[a("tr",null,[a("th",null,"ID"),a("th",null,"Rota"),a("th",null,"Início"),a("th",null,"Fim"),a("th",null,"Status"),a("th",null,"Progresso")])],-1)),a("tbody",null,[(o(!0),d(E,null,I(u.value,e=>(o(),d("tr",{key:e.id},[a("td",null,s(e.id),1),a("td",null,s(e.rota),1),a("td",null,s(y(e.startedAt)),1),a("td",null,s(y(e.finishedAt)),1),a("td",null,s(e.status),1),a("td",null,s(e.visited)+" / "+s(e.total),1)]))),128))])])])):T("",!0)]))}};export{lt as default};
